# Issue 092625-37: Provenance & Calculation Trace Fields

**Priority**: High  
**Component**: Backend / Observability  
**Beta Blocker**: Yes (trust and debugging)  
**Discovered**: 2025-09-26  
**Status**: Awaiting User Testing  
**Resolved**: 

## Problem Description

Users and devs need to understand where numbers come from. Add provenance and calculation trace fields to opportunities and expose them in a debug endpoint.

## Investigation Areas

1. What inputs should be captured (PM price, selected book odds, fair probs, fee cushion).  
2. Minimal but sufficient `calc_notes` to reconstruct EV steps.  
3. Response size control (avoid overly verbose payloads on main endpoints).

## Expected Behavior

Each `Opportunity` includes compact provenance fields and `calc_notes`. The debug endpoint returns a richer trace for the selected item.

## Files to Investigate

- `backend/app/schemas/opportunity.py`  
- `backend/app/services/opportunities.py`  
- `backend/app/api/routes/*`

## Root Cause Analysis

1. **Primary Cause**: No structured provenance in DTOs.  
2. **Contributing Factors**: Early focus on core math.

## Solution Implemented

### 1. Provenance Fields (âœ… Complete)
- Add `source_attribution` (bookmaker, timestamps), `inputs` (pm_price, fair_probs), and `calc_notes` (vig removal basis, payout basis).  
- Keep fields compact; offload full trace to debug endpoint.

### Code Changes

**File Modified**: `backend/app/schemas/opportunity.py`

**Before**:
```text
No provenance, minimal EV fields.
```

**After**:
```text
Compact provenance included; EV derivation trace accessible via debug endpoint.
```

## Testing Requirements

### Manual Testing Steps
1. Fetch an opportunity; inspect provenance fields.  
2. Call debug endpoint for same ID; verify detailed trace.

### Test Scenarios
- [ ] Provenance fields present and populated.  
- [ ] Debug trace includes inputs and intermediate values.

## Status

**Current Status**: Awaiting User Testing  
**Last Updated**: 2025-09-27

### Implementation Checklist
- [x] Add provenance fields to schema  
- [x] Populate from services  
- [x] Tests verify presence

### Completion Criteria (Ready for User Testing)
- [ ] Provenance visible and coherent  
- [ ] Tests pass

### User Testing Confirmation
- [ ] User validates provenance and debug usability  
- [ ] User approves moving to done/complete

### User Confirmation & Actions Required
- None.

## Result

Compact provenance populated on opportunities; debug endpoint available; tests validate.
