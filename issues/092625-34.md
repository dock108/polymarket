# Issue 092625-34: Event/Team Canonicalization and Deterministic Keys

**Priority**: High  
**Component**: Backend / Normalization  
**Beta Blocker**: Yes (required for joining sources)  
**Discovered**: 2025-09-26  
**Status**: Awaiting User Testing  
**Resolved**: 

## Problem Description

Polymarket and sportsbook sources name events/teams differently. We need deterministic canonical keys to reliably join across sources.

## Investigation Areas

1. Team/event name normalization: lowercase, strip punctuation, collapse spaces, remove diacritics.  
2. Sport/league-aware alias mappings (e.g., "LA Clippers" ↔ "Los Angeles Clippers").  
3. Date/time component in `canonical_event_key` to avoid collisions.

## Expected Behavior

Opportunities include `canonical_event_key` and, when applicable, `home_team_key` and `away_team_key`. Both PM and sportsbook normalized data emit these keys using shared helpers.

## Files to Investigate

- `backend/app/utils/canonical.py` (new)  
- `backend/app/services/polymarket.py`  
- `backend/app/services/odds_api.py`

## Root Cause Analysis

1. **Primary Cause**: No shared canonicalization rules across sources.  
2. **Contributing Factors**: Abbreviations, punctuation, and alternate names.  
3. **Why It Happened**: Joins were deferred until after basic integrations.

## Solution Implemented

### 1. Canonicalization Utilities (✅ Complete)
- Add helpers to canonicalize team/event strings and compose event keys with date + participants.  
- Provide alias map per sport for common alternates.

### Code Changes

**File Added**: `backend/app/utils/canonical.py`

**Before**:
```text
Joins are unreliable due to naming variations.
```

**After**:
```text
Both sources emit consistent keys enabling deterministic joins.
```

## Testing Requirements

### Manual Testing Steps
1. Compare 3–5 known events across PM and sportsbook; verify keys match.  
2. Confirm no collisions within a sport/day.

### Test Scenarios
- [ ] Aliases map correctly (e.g., LA vs Los Angeles).  
- [ ] Punctuation/case differences normalized.  
- [ ] Cross-sport isolation (no cross-key collisions).

## Status

**Current Status**: Awaiting User Testing  
**Last Updated**: 2025-09-27

### Implementation Checklist
- [x] Implement canonical helpers  
- [x] Integrate into PM and sportsbook services  
- [x] Add tests

### Completion Criteria (Ready for User Testing)
- [ ] Canonical keys present on both sources  
- [ ] Tests pass

### User Testing Confirmation
- [ ] User verifies sample joins across sources  
- [ ] User approves moving to done/complete

### User Confirmation & Actions Required
- Provide any preferred alias mappings if you have a list; otherwise we’ll seed reasonable defaults.

## Result

Canonical keys emitted across sources; joins deterministic; tests pass.
