# Issue 092825-2: League/Team Parsing Integration and Fuzzy Matching

**Priority**: High  
**Component**: Backend / Parsing  
**Beta Blocker**: No (post-UAT), improves accuracy  
**Discovered**: 2025-09-28  
**Status**: New  
**Resolved**: 

## Problem Description

Polymarket strings vary (questions, titles, tickers). We need robust league/team inference using the Sports Directory, including abbreviations/aliases and safe fuzzy matching for edge cases.

## Investigation Areas

1. Define parser heuristics per market type (futures vs H2H vs props).  
2. Confidence thresholds for fuzzy matches (rapidfuzz) and tie-breaking rules.  
3. Error logging and observability for misses.

## Expected Behavior

`OpportunityEngine` and/or `PolymarketService` infer `league` and team keys consistently from text fields; ambiguous cases are skipped or flagged with low-risk defaults.

## Files to Investigate

- `backend/app/utils/sports_directory.py` (planned)  
- `backend/app/services/polymarket.py`  
- `backend/app/services/opportunities.py`

## Solution Implemented

### 1. Parser Integration (‚è≥ Planned)
- Use directory for exact/alias/abbr hits; fallback to fuzzy (with threshold).  
- Emit `home_team_key`/`away_team_key` or `subject_team_key` where applicable.

### Code Changes

**Files Modified**:  
- `backend/app/services/opportunities.py` (enriched inference)  
- `backend/app/utils/sports_directory.py` (matching logic)

**Before**:
```text
Limited, league-only inference from tags and hint fields.
```

**After**:
```text
Robust league/team inference with clear confidence steps and safe fallbacks.
```

## Testing Requirements

### Manual Testing Steps
1. Validate 10 Polymarket NBA markets (varied text) map to the same team keys as directory.  
2. Confirm ambiguous strings are either skipped or correctly matched with high confidence.

### Test Scenarios
- [ ] Exact matches succeed for city+name and abbreviations.  
- [ ] Aliases ("LA Lakers", "Celtics") map correctly.  
- [ ] Fuzzy low-confidence results are rejected.

## Status

**Current Status**: Planned  
**Last Updated**: 2025-09-28

### Implementation Checklist
- [ ] Integrate directory lookups  
- [ ] Add fuzzy matching with threshold  
- [ ] Add unit tests across edge cases

### Completion Criteria (Ready for User Testing)
- [ ] League/team inference works on sample set  
- [ ] Tests pass

### User Testing Confirmation
- [ ] User validates inference on real markets  
- [ ] User approves moving to done/complete

### User Confirmation & Actions Required
- Provide list of priority leagues and tricky alias examples to seed tests.

## Result

[TBD]
