# Issue 092625-36: Compare & Join Engine (Polymarket vs Sportsbook) — EV Computation

**Priority**: High  
**Component**: Backend / Aggregation  
**Beta Blocker**: Yes (first meaningful EV)  
**Discovered**: 2025-09-26  
**Status**: Awaiting User Testing  
**Resolved**: 

## Problem Description

With canonical keys and normalized sportsbook H2H fair probabilities, we can compute EV by comparing Polymarket price to sportsbook fair probability. Implement the join logic and EV calculation.

## Investigation Areas

1. Join strategy on `canonical_event_key` (and teams where relevant).  
2. EV formula selection: use sportsbook fair probability as `P_true` and PM price as market price.  
3. Output annotations: `comparison_basis="sportsbook_fair"`, `comparison_sources=[...]`.

## Expected Behavior

For each joined event, compute per-side EV and include EV fields in `Opportunity`. Negative, zero, and positive EVs represented; no results when join missing.

## Files to Investigate

- `backend/app/services/opportunities.py`  
- `backend/app/services/odds_api.py`  
- `backend/app/utils/odds.py`

## Root Cause Analysis

1. **Primary Cause**: EV was previously implied without a comparison source.  
2. **Contributing Factors**: Missing canonicalization delayed joining.  
3. **Why It Happened**: Phased bring-up.

## Solution Implemented

### 1. Join & EV Computation (✅ Complete)
- Join PM and sportsbook by canonical keys.  
- For Yes-side markets, use `P_true = fair_prob_for_outcome` and PM `price` (pre-fee or post-fee only for display; EV basis documented).  
- Set `comparison_basis` and `comparison_sources` accordingly.

### Code Changes

**File Modified**: `backend/app/services/opportunities.py`

**Before**:
```text
EV baseline at 0 for PM-only; no join.
```

**After**:
```text
EV computed against sportsbook fair probabilities for joined events; metadata included.
```

## Testing Requirements

### Manual Testing Steps
1. Use snapshot fixtures to simulate a few events; verify EV signs and magnitudes.  
2. Inspect a sample `Opportunity` for correct `comparison_*` fields.

### Test Scenarios
- [ ] Joined events produce non-zero EVs where expected.  
- [ ] Unjoined events remain at EV=0 with `basis=none`.  
- [ ] Metadata fields present.

## Status

**Current Status**: Awaiting User Testing  
**Last Updated**: 2025-09-27

### Implementation Checklist
- [x] Implement join logic  
- [x] Compute EV per side  
- [x] Add tests with fixtures

### Completion Criteria (Ready for User Testing)
- [ ] EV appears only when a valid join exists  
- [ ] Tests pass

### User Testing Confirmation
- [ ] User validates EV values on sample events  
- [ ] User approves moving to done/complete

### User Confirmation & Actions Required
- None.

## Result

Join performed via `canonical_event_key`; EV computed against sportsbook fair; snapshot tests added.
