# Issue 092625-35: Sportsbook H2H Fair-Probability Engine (Normalized)

**Priority**: High  
**Component**: Backend / Odds API Integration  
**Beta Blocker**: Yes (unblocks EV comparison)  
**Discovered**: 2025-09-26  
**Status**: RESOLVED  
**Resolved**: 2025-09-28

## Problem Description

We need reliable H2H fair probabilities from the sportsbook API. Handle American odds, conservative line selection across target books, vig removal, and normalized outputs ready to join.

## Investigation Areas

1. Enforce `oddsFormat=american`; consistent implied probability conversion.  
2. Conservative line selection per side across configured books (shortest odds).  
3. Vig removal to produce p' that sum to 1.0; compute fair decimal odds.  
4. Emit canonical keys for join.

## Expected Behavior

For each event: emit both sides with `fair_probability`, `fair_decimal_odds`, `selected_bookmaker`, and canonical keys. Omit incomplete/invalid lines.

## Files to Investigate

- `backend/app/services/odds_api.py`  
- `backend/app/utils/odds.py`  
- `backend/tests/test_odds_h2h_fair.py`

## Root Cause Analysis

1. **Primary Cause**: Partial normalization without canonical keys/attribution.  
2. **Contributing Factors**: Inconsistent odds formats and sparse lines.  
3. **Why It Happened**: Early smoke tests focused on connectivity.

## Solution Implemented

### 1. H2H Normalization (âœ… Complete)
- Enforce American odds; convert consistently.  
- Per-side conservative selection across allowlisted books.  
- Remove vig; annotate fair probs/odds and attribution.  
- Emit canonical keys.

### Code Changes

**File Modified**: `backend/app/services/odds_api.py`

**Before**:
```text
Basic H2H computation present but not fully normalized for joining.
```

**After**:
```text
Outputs include canonical keys and selected book; ready for joining.
```

## Testing Requirements

### Manual Testing Steps
1. Pull a sport and inspect normalized lines.  
2. Verify fair prob sums ~ 1.0 per game.

### Test Scenarios
- [x] Vig removal sums to 1.0 within tolerance.  
- [x] Conservative line selection respected.  
- [x] Canonical keys present.

## Status

**Current Status**: RESOLVED  
**Last Updated**: 2025-09-28

### Implementation Checklist
- [x] Normalize H2H lines  
- [x] Add keys and attribution  
- [x] Tests pass

### Completion Criteria (Ready for User Testing)
- [x] Per-event fair probs normalized  
- [x] Join-ready outputs

### User Testing Confirmation
- [x] User validates normalized sportsbook outputs  
- [x] User approves moving to done/complete

### User Confirmation & Actions Required
- Confirm bookmaker allowlist for v1 (Pinnacle, Betfair, Caesars, Circa, Bookmaker.eu).

## Result

H2H lines normalized with fair probabilities; canonical keys and attribution included; tests pass.
 
Closing notes: Event title construction standardized to "A vs B" for consistent matching with Polymarket.
