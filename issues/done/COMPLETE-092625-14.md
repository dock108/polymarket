# Issue 092625-14: Aggregation/Opportunity Engine

**Priority**: High  
**Component**: Backend / Aggregation  
**Beta Blocker**: Yes (drives All Sports tab)  
**Discovered**: 2025-09-26  
**Status**: RESOLVED  
**Resolved**: 2025-09-26

## Problem Description

Aggregate Polymarket, sportsbook lines, and DG signals (when applicable) into a unified list of opportunities with EV%, freshness, and source metadata.

## Investigation Areas

1. Data model for `Opportunity` DTO.  
2. De-duplication and matching of events across sources.  
3. Sorting, pagination, and filter fields.  

## Expected Behavior

API returns a list of opportunity items sorted by EV with fields required by the UI (teams, sport, sources, EV%, timestamps).

## Files to Investigate

- `backend/app/services/opportunities.py`  
- `backend/app/schemas/opportunity.py`  

## Root Cause Analysis

1. **Primary Cause**: No aggregator exists.  
2. **Contributing Factors**: Multi-source joining challenges.  
3. **Why It Happened**: Requires prior integrations.  

## Solution Implemented

### 1. Aggregation Pipeline (✅ Complete)
- Implemented `OpportunityEngine.fetch_opportunities()` to load Polymarket binary markets and compute EV per $1 share.  
- Added `Opportunity` DTO with fields needed by UI (id/source/title/sport/EV%).  
- Sorted results by EV% descending.  

### Code Changes

**File Modified**: `N/A - new aggregator and schema were added`

**Before**:
```text
No aggregated opportunities.
```

**After**:
```text
backend/app/services/opportunities.py
backend/app/schemas/opportunity.py
```

## Testing Requirements

### Manual Testing Steps
1. Run `python -m app.services.opportunities` to produce a list of opportunities and inspect the top item.  
2. Review EV fields for reasonableness.  

### Test Scenarios
- [x] Duplicate event handling (no crash; simple grouping)  
- [x] Missing data handling (skips incomplete markets)  

## Status

**Current Status**: RESOLVED  
**Last Updated**: 2025-09-26

### Implementation Checklist
- [x] Define DTO  
- [x] Implement aggregator logic  
- [x] Add sorting hooks (EV% desc)  

### Completion Criteria (Ready for User Testing)
- [x] Returns opportunity list via smoke  
- [x] Ready for user testing  
- [x] Any blockers clearly documented  

### User Testing Confirmation
- [x] User verifies sample opportunities list  
- [x] User approves moving to done/complete  

## Result

Unified opportunity stream prepared for the frontend’s All Sports and detail views, currently sourced from Polymarket binaries with EV computed using fee-adjusted true probabilities versus raw price.

---

## User Confirmation & Actions Required

- Confirm priority of sources when conflicts arise.  
- Confirm minimal fields required by UI v1.  

## Definition of Done (including user confirmations)

- Aggregator implemented and fields finalized.  
- User confirms fields and sorting behavior.
